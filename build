#!/usr/bin/env bash

echo "Downloading dependencies..."
swift build --fetch

echo "Fixing SPM bug..."
rm -rf Packages/*/Tests

echo -e '\n' >> $PWD/Packages/MySQL-0.1.12/Package.swift
echo 'let lib = Product(name: "MySQL", type: .Library(.Dynamic), modules: "MySQL"); products.append(lib)' >> $PWD/Packages/MySQL-0.1.12/Package.swift

echo -e '\n' >> $PWD/Packages/CryptoSwift-0.2.3/Package.swift
echo 'let lib = Product(name: "CryptoSwift", type: .Library(.Dynamic), modules: "CryptoSwift"); products.append(lib)' >> $PWD/Packages/CryptoSwift-0.2.3/Package.swift

# echo "Reclone the CryptoSwift and Switch to the delveop branch"
# rm -rf Packages/CryptoSwift-0.2.3
# git clone https://github.com/krzyzanowskim/CryptoSwift.git -b develop Packages/CryptoSwift-0.2.3

echo "Replace the code now and rebuild it.."

echo "Building..."

swift build -Xlinker -L/usr/local/lib -Xcc -I/usr/local/include/mysql -v

# replace CryptoSwift at SHA2.swift line 276
# result += [ UInt8(item & 0xff) ]
# result += [ UInt8((item >> 8) & 0xff) ]
# result += [ UInt8((item >> 16) & 0xff) ]
# result += [ UInt8((item >> 24) & 0xff) ]
# result += [ UInt8((item >> 32) & 0xff) ]
# result += [ UInt8((item >> 40) & 0xff) ]
# result += [ UInt8((item >> 48) & 0xff) ]
# result += [ UInt8((item >> 56) & 0xff) ]
